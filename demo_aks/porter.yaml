# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/bundle/manifest/file-format/ for a description of all the allowed fields in this document.
# See https://porter.sh/author-bundles for documentation on how to configure your bundle.
# Uncomment out the sections below to take full advantage of what Porter can do!

# Optional indicator of the resource type of this file
schemaType: Bundle

# Version of the porter.yaml schema used by this file.
schemaVersion: 1.0.1

# Name of the bundle
name: demo_aks

# Version of the bundle. Change this each time you modify a published bundle.
version: 0.1.0

# az aks create -g sre-hackathon -n demoaks --node-count 1
description: "Bundle for creating an AKS cluster"

# Registry where the bundle is published to by default
registry: "localhost:5000"

credentials:
- name: azure_client_id
  env: AZURE_CLIENT_ID
  description: AAD Client ID for Azure account authentication - used for AKS Cluster SPN details and for authentication to azure to get KubeConfig
- name: azure_tenant_id
  env: AZURE_TENANT_ID
  description: Azure AAD Tenant Id for Azure account authentication - used to authenticate to Azure to get KubeConfig 
- name: azure_client_secret
  env: AZURE_CLIENT_SECRET
  description: AAD Client Secret for Azure account authentication - used for AKS Cluster SPN details and for authentication to azure to get KubeConfig
- name: azure_subscription_id
  env: AZURE_SUBSCRIPTION_ID
  description: Azure Subscription Id used to set the subscription where the account has access to multiple subscriptions

parameters:
  - name: rg_name
    type: string
    description: "Resource group in which AKS will be created"
    default: "demorg"
    applyTo:
      - install
      - uninstall
      
  - name: aks_name
    type: string
    description: "AKS name"
    default: "demoaks"
    applyTo:
      - install
      - uninstall
  

# https://learn.microsoft.com/en-us/cli/azure/reference-index?view=azure-cli-latest
mixins:
  - exec
  - az:
      extensions:
      - aks-preview

# create AKS cluster
install:
  - az:
      description: "Azure CLI login"
      arguments:
        - login
      flags:
        service-principal:
        username: ${ bundle.credentials.azure_client_id }
        password: ${ bundle.credentials.azure_client_secret }
        tenant: ${ bundle.credentials.azure_tenant_id }

  - az:
      description: "Azure set subscription Id"
      arguments:
        - "account"
        - "set"
      flags:
        subscription: ${ bundle.credentials.azure_subscription_id }


  - az:
      description: "Create AKS cluster"
      arguments:
        - "aks"
        - "create"
      flags:
        resource-group: ${ bundle.parameters.rg_name }
        name: ${ bundle.parameters.aks_name }
        node-count: 1 
        generate-ssh-key: 


# Define the steps that should execute when the bundle is upgraded
upgrade:
  - exec:
      description: "World 2.0"
      command: ./helpers.sh
      arguments:
        - upgrade

# Define the steps that should execute when the bundle is uninstalled
uninstall:
  - az:
      description: "Azure CLI login"
      arguments:
        - login
      flags:
        service-principal:
        username: ${ bundle.credentials.azure_client_id }
        password: ${ bundle.credentials.azure_client_secret }
        tenant: ${ bundle.credentials.azure_tenant_id }

  - az:
      description: "Azure set subscription Id"
      arguments:
        - "account"
        - "set"
      flags:
        subscription: ${ bundle.credentials.azure_subscription_id }
  - az:
      description: "Delete AKS cluster"
      arguments:
        - "aks"
        - "delete"
      flags:
        resource-group:  ${ bundle.parameters.rg_name }
        name: ${ bundle.parameters.aks_name }
        yes: 